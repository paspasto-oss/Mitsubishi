<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spektra Install – Cenová ponuka</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

  <!-- html2pdf (bez integrity checku pre istotu) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --brand-red:#D60000;
      --text:#111827;
      --muted:#6b7280;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --chip:#fef2f2;
      --ok:#16a34a;
      --warn:#b45309;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Montserrat,Roboto,system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:var(--text)}
    
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:420px 1fr;gap:16px}
    @media (max-width: 980px){.wrap{grid-template-columns:1fr;}}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .panel .hd{padding:16px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
    
    /* OPRAVA: Jednoduché logo bez gradientov (pre stabilitu PDF) */
    .logo-dot{width:38px;height:38px;border-radius:999px;background:var(--brand-red);}
    
    .title{display:flex;align-items:center;gap:10px}
    .title h1{font-size:16px;margin:0;font-weight:800;letter-spacing:.2px}
    .title .sub{font-size:12px;color:var(--muted);margin:0}

    .bd{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-1{display:grid;grid-template-columns:1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, select, textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;font:inherit;background:#fff;outline:none}
    textarea{min-height:80px;resize:vertical}
    
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--brand-red);color:#fff}
    .btn-secondary{background:#1f2937;color:#fff}
    .btn-ghost{background:#fff;border:1px solid var(--border)}
    .btn-soft{background:var(--chip);color:var(--brand-red);border:1px solid #fecaca}

    .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:10px}

    /* Offer preview styles */
    .page{width:210mm;min-height:297mm;margin:0 auto;background:#fff;position:relative}
    .paper{padding:14mm}

    .offer-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;border-bottom:2px solid var(--border);padding-bottom:10px;margin-bottom:14px}
    .brand{display:flex;gap:12px;align-items:center}
    
    /* OPRAVA: Jednoduché logo pre PDF */
    .brand-mark{width:52px;height:52px;border-radius:999px;background:var(--brand-red);}
    
    .brand h2{margin:0;font-size:18px;font-weight:800}
    .brand p{margin:2px 0 0;color:var(--muted);font-size:11px}
    .meta{font-size:11px;color:var(--muted);text-align:right}
    .meta strong{color:var(--text)}

    .sec{margin:14px 0}
    .sec h3{margin:0 0 8px;font-size:13px;font-weight:800}
    .sec p{margin:0;color:#111827;font-size:11.5px;line-height:1.45}

    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}

    .box{border:1px solid var(--border);border-radius:12px;padding:10px}
    .box .k{font-size:10.5px;color:var(--muted)}
    .box .v{font-size:12px;font-weight:700;margin-top:2px}

    table{width:100%;border-collapse:collapse;font-size:11px}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;vertical-align:top}
    th{background:#fafafa;font-weight:800}
    .right{text-align:right}

    .sum{border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .sum .line{display:flex;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--border);font-size:11.5px}
    .sum .line:last-child{border-bottom:0}
    .sum .grand{background:#fff5f5;font-weight:900}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:11px;font-weight:800}
    .badge-ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .badge-warn{background:#fff7ed;color:var(--warn);border:1px solid #fed7aa}
    .badge-err{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5}

    .footer{margin-top:18px;padding-top:10px;border-top:2px solid var(--border);display:flex;justify-content:space-between;gap:10px}
    .footer p{margin:0;font-size:10.5px;color:var(--muted);line-height:1.4}

    /* =========================================
       TLAČOVÉ ŠTÝLY (Native Print / PDF)
       ========================================= */
    @media print {
      body { background: #fff; margin: 0; }
      .wrap { display: block; margin: 0; padding: 0; max-width: none; }
      
      /* Skryť ovládací panel pri tlači */
      .panel:first-child { display: none !important; }
      
      /* Skryť hlavičku náhľadu */
      .panel .hd { display: none !important; }
      
      /* Upraviť panel s náhľadom pre tlač */
      .panel { border: 0; box-shadow: none; border-radius: 0; overflow: visible; }
      .bd { padding: 0; background: #fff !important; }
      .page { width: 100%; min-height: auto; margin: 0; border: 0; }
      .paper { padding: 0 10mm; } /* Menšie okraje pre tlačiareň */
      
      /* Skryť triedu no-print */
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- OVLÁDACÍ PANEL -->
    <section class="panel no-print">
      <div class="hd">
        <div class="title">
          <div class="logo-dot"></div>
          <div>
            <h1>Generátor ponuky</h1>
            <p class="sub">Spektra Install • Midea</p>
          </div>
        </div>
        <span class="badge badge-ok" id="statusBadge">● Pripravené</span>
      </div>

      <div class="bd">
        <div class="grid">
          <div>
            <label>Číslo ponuky</label>
            <input id="offerNo" value="01/2026" />
          </div>
          <div>
            <label>Dátum</label>
            <input id="offerDate" type="date" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="grid">
          <div>
            <label>Meno zákazníka</label>
            <input id="custName" placeholder="Meno Priezvisko" />
          </div>
          <div>
            <label>Telefón</label>
            <input id="custPhone" placeholder="0900 000 000" />
          </div>
          <div style="grid-column:1/-1">
            <label>Adresa</label>
            <input id="custAddr" placeholder="Ulica, mesto, PSČ" />
          </div>
          <div style="grid-column:1/-1">
            <label>E-mail</label>
            <input id="custEmail" placeholder="email@domain.sk" />
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="grid-1">
          <div>
            <label>Vybrať variant</label>
            <select id="variant">
              <option value="8">Variant A – 8 kW</option>
              <option value="12" selected>Variant B – 12 kW</option>
              <option value="16">Variant C – 16 kW</option>
            </select>
          </div>
          <div class="grid">
            <div>
              <label>Zásobník TÚV</label>
              <select id="tank">
                <option value="200">200 l</option>
                <option value="300" selected>300 l</option>
              </select>
            </div>
            <div>
              <label>DPH</label>
              <select id="vat">
                <option value="20" selected>20 %</option>
                <option value="23">23 %</option>
                <option value="0">0 %</option>
              </select>
            </div>
          </div>
          <div class="grid">
            <div>
              <label>Dotácia</label>
              <select id="voucher">
                <option value="3400">– 3 400 € (8 kW)</option>
                <option value="3800" selected>– 3 800 € (12–16 kW)</option>
                <option value="0">0 €</option>
              </select>
            </div>
            <div>
              <label>Zľava</label>
              <input id="discount" type="number" min="0" step="1" value="0" />
            </div>
          </div>
          <div>
            <label>Poznámka</label>
            <textarea id="note" placeholder="Krátka poznámka..."></textarea>
          </div>
        </div>
        <div style="height:12px"></div>
        
        <label>Možnosti exportu:</label>
        <div class="btns">
          <button class="btn-primary" id="btnPdf">Stiahnuť PDF (Script)</button>
          <button class="btn-secondary" id="btnPrint" title="Funguje vždy">Tlačiť / PDF (Prehliadač)</button>
          <button class="btn-ghost" id="btnReset">Reset</button>
          <button class="btn-soft" id="btnSave">Uložiť</button>
        </div>
        <div class="hint">
          Ak tlačidlo "Stiahnuť PDF" nefunguje, použite tmavé tlačidlo "Tlačiť / PDF". Otvorí sa dialóg tlače, kde vyberte "Uložiť ako PDF".
        </div>
      </div>
    </section>

    <!-- NÁHĽAD (PRAVÁ STRANA) -->
    <section class="panel">
      <div class="hd no-print">
        <div class="title">
          <div class="logo-dot"></div>
          <div>
            <h1>Náhľad ponuky</h1>
            <p class="sub">Výstupný dokument</p>
          </div>
        </div>
      </div>

      <div class="bd" style="background:#f8fafc">
        <div id="pdfArea" class="page">
          <div class="paper">
            
            <!-- HLAVIČKA DOKUMENTU -->
            <div class="offer-header">
              <div class="brand">
                <div class="brand-mark" aria-hidden="true"></div>
                <div>
                  <h2>Spektra Install s. r. o.</h2>
                  <p>Hollého 210, 015 01 Rajec • www.spektrainstall.sk</p>
                  <p style="margin-top:4px"><span class="badge badge-ok">Midea Nature R290</span></p>
                </div>
              </div>
              <div class="meta">
                <div><strong>Cenová ponuka</strong></div>
                <div>Číslo: <strong id="vOfferNo">01/2026</strong></div>
                <div>Dátum: <strong id="vOfferDate">23. 1. 2026</strong></div>
              </div>
            </div>

            <!-- ADRESY -->
            <div class="two">
              <div class="sec box">
                <div class="k">Dodávateľ</div>
                <div class="v">Spektra Install s. r. o.</div>
                <div class="k">Adresa</div>
                <div class="v" style="font-weight:600">Hollého 210, Rajec 015 01</div>
                <div class="k">Kontakt</div>
                <div class="v" style="font-weight:600">www.spektrainstall.sk</div>
              </div>
              <div class="sec box">
                <div class="k">Investor</div>
                <div class="v" id="vCustName">—</div>
                <div class="k">Adresa</div>
                <div class="v" id="vCustAddr">—</div>
                <div class="k">Telefón / e‑mail</div>
                <div class="v"><span id="vCustPhone">—</span> • <span id="vCustEmail">—</span></div>
              </div>
            </div>

            <!-- ÚVOD -->
            <div class="sec">
              <h3>Úvod</h3>
              <p>
                Ďakujeme za Váš záujem. Na základe poskytnutých vstupných údajov predkladáme cenovú ponuku na dodávku a montáž
                tepelného čerpadla <b>Midea Nature R290</b> vrátane montážnych prác a potrebného materiálu.
                <span id="vNoteInline"></span>
              </p>
            </div>

            <!-- RIEŠENIE -->
            <div class="sec">
              <h3>Navrhované riešenie</h3>
              <div class="two">
                <div class="box">
                  <div class="k">Zvolený variant</div>
                  <div class="v" id="vVariant">Variant B – 12 kW</div>
                </div>
                <div class="box">
                  <div class="k">Zásobník TÚV</div>
                  <div class="v" id="vTank">300 l</div>
                </div>
              </div>
            </div>

            <!-- POLOŽKY -->
            <div class="sec">
              <h3>Podrobný rozpis dodávky</h3>
              <table>
                <thead>
                  <tr>
                    <th>Položka</th>
                    <th class="right">Cena bez DPH</th>
                    <th class="right">DPH</th>
                    <th class="right">Cena s DPH</th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <!-- SÚHRN -->
            <div class="sec">
              <h3>Celkový súhrn</h3>
              <div class="sum">
                <div class="line"><span>Medzisúčet (bez DPH)</span><strong id="sumNet">0 €</strong></div>
                <div class="line"><span>DPH</span><strong id="sumVat">0 €</strong></div>
                <div class="line"><span>Zľava</span><strong id="sumDisc">0 €</strong></div>
                <div class="line"><span>Dotácia (Zelená domácnostiam)</span><strong id="sumVoucher">0 €</strong></div>
                <div class="line grand"><span>Konečná cena</span><strong id="sumGrand">0 €</strong></div>
              </div>
              <p style="margin-top:8px;font-size:10.5px;color:var(--muted)">
                Pozn.: Výška dotácie je orientačná a závisí od podmienok programu a schválenia poukážky.
              </p>
            </div>

            <!-- TERMÍNY -->
            <div class="sec">
              <h3>Termíny a podmienky</h3>
              <p>
                Platnosť ponuky: <b>30 dní</b>. Termín realizácie: zvyčajne <b>10–15 pracovných dní</b> od potvrdenia objednávky.
                Dĺžka montáže: <b>1–2 dni</b> (podľa rozsahu). Záruka na montážne práce: <b>24 mesiacov</b>.
              </p>
            </div>

            <!-- PÄTIČKA -->
            <div class="footer">
              <p>
                <b>Spektra Install</b><br>
                montáž • servis • predaj
              </p>
              <p style="text-align:right">
                Vypracoval: <b>Pavol Pastorek</b><br>
                Podpis: ______________________
              </p>
            </div>

          </div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // =========================
    // PRICES (CENNÍK)
    // =========================
    const PRICES = {
      hp: { 
        8: 7200,
        12: 8400,
        16: 9600,
      },
      tank: {
        200: 1050,
        300: 1290,
      },
      material: [
        { name: 'Hydraulické napojenie vykurovania', gross: 420 },
        { name: 'Filtrácia systému (magnetický filter)', gross: 150 },
        { name: 'Expanzná nádoba TÚV + poistná skupina', gross: 160 },
        { name: 'Elektroinštalačný materiál', gross: 180 },
        { name: 'Drobný montážny materiál', gross: 120 },
      ],
      labor: [
        { name: 'Osadenie a napojenie tepelného čerpadla', gross: 650 },
        { name: 'Elektroinštalačné práce', gross: 280 },
        { name: 'Napustenie, preplach a odvzdušnenie systému', gross: 220 },
        { name: 'Uvedenie do prevádzky a nastavenie regulácie', gross: 250 },
      ]
    };

    // Helpers
    const eur = (n) => new Intl.NumberFormat('sk-SK', { style:'currency', currency:'EUR', maximumFractionDigits:0 }).format(n);
    const pad2 = (n) => String(n).padStart(2,'0');
    const formatDateSK = (iso) => {
      if(!iso) return '—';
      const d = new Date(iso);
      return `${d.getDate()}. ${d.getMonth()+1}. ${d.getFullYear()}`;
    };

    // DOM Elements
    const el = (id) => document.getElementById(id);
    const inputs = ['offerNo','offerDate','custName','custPhone','custAddr','custEmail','variant','tank','vat','voucher','discount','note']
      .map(id => el(id));
    
    // Status Badge
    const statusBadge = el('statusBadge');
    function setBadge(ok=true, text='● Pripravené'){
      statusBadge.className = ok ? 'badge badge-ok' : 'badge badge-warn';
      if(!ok && text.includes('Chyba')) statusBadge.className = 'badge badge-err';
      statusBadge.textContent = text;
    }

    // MAIN LOGIC
    function compute(){
      // Copy basic info
      el('vOfferNo').textContent = el('offerNo').value || '—';
      el('vOfferDate').textContent = formatDateSK(el('offerDate').value);
      el('vCustName').textContent = el('custName').value || '—';
      el('vCustPhone').textContent = el('custPhone').value || '—';
      el('vCustAddr').textContent = el('custAddr').value || '—';
      el('vCustEmail').textContent = el('custEmail').value || '—';
      
      const vVal = el('variant').value;
      const tVal = el('tank').value;
      el('vVariant').textContent = vVal === '8' ? 'Variant A – 8 kW' : (vVal === '12' ? 'Variant B – 12 kW' : 'Variant C – 16 kW');
      el('vTank').textContent = `${tVal} l`;
      
      const nVal = el('note').value.trim();
      el('vNoteInline').textContent = nVal ? ` Poznámka: ${nVal}` : '';

      // Calculate Prices
      const vatRate = Number(el('vat').value)/100;
      const disc = Number(el('discount').value || 0);
      const vouch = Number(el('voucher').value || 0);

      const items = [];
      items.push({ name: `Tepelné čerpadlo Midea Nature R290 – ${vVal} kW`, gross: PRICES.hp[vVal] });
      items.push({ name: `Zásobník TÚV ${tVal} l`, gross: PRICES.tank[tVal] });
      PRICES.material.forEach(x=>items.push({ name: x.name, gross: x.gross }));
      PRICES.labor.forEach(x=>items.push({ name: x.name, gross: x.gross }));

      el('itemsBody').innerHTML = '';
      let totalGross = 0, totalNet = 0, totalVat = 0;

      items.forEach(it => {
        const gross = it.gross;
        const net = vatRate === 0 ? gross : gross / (1 + vatRate);
        const vatAmt = gross - net;
        totalGross += gross;
        totalNet += net;
        totalVat += vatAmt;

        el('itemsBody').innerHTML += `
          <tr>
            <td>${it.name}</td>
            <td class="right">${eur(net)}</td>
            <td class="right">${eur(vatAmt)}</td>
            <td class="right"><b>${eur(gross)}</b></td>
          </tr>
        `;
      });

      const grandGross = Math.max(0, totalGross - disc - vouch);
      const grandNet = vatRate === 0 ? grandGross : grandGross / (1 + vatRate);
      
      el('sumNet').textContent = eur(totalNet);
      el('sumVat').textContent = eur(totalVat);
      el('sumDisc').textContent = eur(disc);
      el('sumVoucher').textContent = eur(vouch);
      el('sumGrand').textContent = eur(grandGross);

      setBadge(Boolean(el('custName').value), Boolean(el('custName').value) ? '● Pripravené' : '● Doplň meno');
    }

    // INIT
    (function initDate(){
      const now = new Date();
      el('offerDate').value = `${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}`;
      compute();
    })();

    // EVENTS
    inputs.forEach(i => {
      i.addEventListener('input', compute);
      i.addEventListener('change', compute);
    });

    // 1. JS PDF Export (html2pdf)
    el('btnPdf').addEventListener('click', async () => {
      try {
        if (typeof html2pdf === 'undefined') throw new Error("Knižnica html2pdf sa nenačítala (skontrolujte internet).");
        
        compute();
        window.scrollTo(0, 0); // Dôležité: posunúť hore, inak môže orezať PDF
        
        const name = (el('custName').value.trim() || 'Zakaznik').replace(/[^a-zA-Z0-9]/g,'_');
        const element = document.getElementById('pdfArea');
        const opt = {
          margin: 0,
          filename: `Ponuka_${name}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        setBadge(true, '● Generujem...');
        await html2pdf().set(opt).from(element).save();
        setBadge(true, '● Hotovo');
      } catch (e) {
        alert("Chyba exportu: " + e.message + "\n\nSkúste použiť tmavé tlačidlo 'Tlačiť / PDF' vedľa.");
        setBadge(false, '● Chyba');
      }
    });

    // 2. Native Print / PDF (Fallback)
    el('btnPrint').addEventListener('click', () => {
      compute();
      window.print();
    });

    // Storage
    const KEY = 'spektra_offer_v2';
    el('btnSave').addEventListener('click', () => {
      const data = {};
      inputs.forEach(i => data[i.id] = i.value);
      localStorage.setItem(KEY, JSON.stringify(data));
      setBadge(true, '● Uložené');
    });
    
    el('btnReset').addEventListener('click', () => {
      if(confirm('Naozaj vymazať formulár?')) {
        localStorage.removeItem(KEY);
        location.reload();
      }
    });

    // Load
    try {
      const saved = JSON.parse(localStorage.getItem(KEY));
      if(saved) {
        Object.keys(saved).forEach(k => { if(el(k)) el(k).value = saved[k]; });
        compute();
      }
    } catch(e){}

  </script>
</body>
</html>

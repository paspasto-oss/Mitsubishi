<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cenov√° ponuka ‚Äì Spektra Install</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }

    /* ================= PRINT ‚Äì plnohodnotn√Ω PDF v√Ωstup ================= */
    @media print {
      @page { size: A4; margin: 12mm; }

      html, body {
        background: #ffffff !important;
        color: #0f172a !important;
        font-size: 11pt !important;
        line-height: 1.35 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      /* Skry≈• ovl√°dacie prvky pri tlaƒçi */
      .no-print { display: none !important; }

      /* Bez tie≈àov a zaoblen√≠ (ƒçistej≈°√≠ PDF v√Ωstup) */
      .shadow, .shadow-sm, .shadow-md, .shadow-lg, .shadow-xl { box-shadow: none !important; }
      .rounded, .rounded-lg, .rounded-xl, .rounded-2xl { border-radius: 0 !important; }

      /* Layout kontajnera pre tlaƒç */
      .print-container {
        max-width: none !important;
        width: 100% !important;
        margin: 0 !important;
        border: none !important;
      }

      /* HLAVIƒåKA ‚Äì v≈ædy vedƒæa seba */
      .header-row {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 10mm !important;
        align-items: flex-start !important;
      }
      .header-left  { width: 58% !important; }
      .header-right { width: 42% !important; text-align: right !important; }

      /* Nadpisy */
      h1 { font-size: 20pt !important; line-height: 1.15 !important; margin-bottom: 2mm !important; }
      h2 { font-size: 14pt !important; line-height: 1.2 !important; margin-bottom: 2mm !important; }
      h3 { font-size: 12.5pt !important; line-height: 1.2 !important; margin-bottom: 2mm !important; }
      h4 { font-size: 11pt !important; line-height: 1.25 !important; }

      /* Text */
      p, li { font-size: 10.5pt !important; line-height: 1.35 !important; }
      .text-xs { font-size: 9pt !important; }
      .text-sm { font-size: 10pt !important; }

      /* Tabuƒæky */
      table { width: 100% !important; border-collapse: collapse !important; table-layout: fixed !important; }
      th {
        font-size: 9.5pt !important;
        letter-spacing: .04em !important;
        padding: 6px 8px !important;
        line-height: 1.2 !important;
      }
      td {
        font-size: 10pt !important;
        padding: 6px 8px !important;
        line-height: 1.3 !important;
        vertical-align: top !important;
        word-break: break-word !important;
      }

      thead { display: table-header-group; }
      tfoot { display: table-footer-group; }
      tr { page-break-inside: avoid !important; }

      /* Sekƒçn√© medzery */
      section { margin-bottom: 10mm !important; }

      /* Z√°kaz l√°mania d√¥le≈æit√Ωch blokov */
      .avoid-break, .avoid-break-inside { page-break-inside: avoid !important; break-inside: avoid !important; }

      /* Farby ‚Äì zachova≈• kontrast */
      .bg-slate-800 { background: #0f172a !important; }
      .text-white { color: #ffffff !important; }
      .text-slate-400 { color: #6b7280 !important; }
      .text-slate-300 { color: #94a3b8 !important; }
      .text-red-600 { color: #dc2626 !important; }
    }

    /* SCREEN layout */
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 24px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body class="bg-gray-100 p-4 md:p-8 text-slate-800">

  <div class="print-container max-w-4xl mx-auto bg-white shadow-xl rounded-lg overflow-hidden">

    <!-- HLAVIƒåKA (biela + horn√Ω tmavomodr√Ω p√°s + ƒçerven√Ω pruh vƒæavo) -->
    <header class="relative bg-white border-b border-slate-200">
      <div class="absolute left-0 top-0 w-full h-1 bg-gradient-to-r from-slate-900 via-slate-800 to-red-600"></div>
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>

      <div class="p-8">
        <div class="header-row">
          <div class="header-left">
            <div class="flex items-start gap-4">
              <div class="flex items-center justify-center h-12 w-12 rounded bg-red-600 text-white font-black text-xl">S</div>
              <div>
                <div class="text-xl font-extrabold leading-tight">
                  <span class="text-slate-900">SPEKTRA</span> <span class="text-red-600">INSTALL</span>
                </div>
                <div class="mt-1 text-xs text-slate-500 uppercase tracking-wider">Holl√©ho 210, 015 01 Rajec</div>
                <div class="text-xs text-slate-500">spektrainstall@gmail.com | 0917 572 221</div>
              </div>
            </div>

            <!-- Z√°kazn√≠k (v√Ωstup do PDF) -->
            <div class="mt-6">
              <p class="text-[10px] uppercase text-slate-400 font-bold tracking-widest border-b border-slate-200 inline-block pb-1">Z√°kazn√≠k / Odberateƒæ</p>
              <div id="customerDisplay" class="mt-2 text-sm font-semibold whitespace-pre-line leading-relaxed text-slate-900">
V√°≈æen√Ω z√°kazn√≠k
Ulica 123
000 00 Mesto
              </div>
            </div>

            <!-- Editor (iba na obrazovke) -->
            <div class="no-print mt-6 p-4 bg-slate-900 rounded-lg border border-slate-700">
              <div class="flex items-center gap-2 mb-3 border-b border-slate-700 pb-2">
                <span class="text-lg">üõ†</span>
                <h3 class="text-xs uppercase text-slate-200 font-bold">Editor ponuky</h3>
              </div>

              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-[10px] text-slate-400 mb-1 uppercase">ƒå√≠slo ponuky</label>
                    <input type="text" id="offerNumberInput" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="2026/xxx" value="2026/001">
                  </div>
                  <div>
                    <label class="block text-[10px] text-slate-400 mb-1 uppercase">Technol√≥gia</label>
                    <select id="offerSelect" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none">
                      <option value="mitsubishi">Mitsubishi Zubadan 12 kW</option>
                      <option value="panasonic_split">Panasonic Aquarea K 9 kW</option>
                      <option value="hyundai_supreme_10">Hyundai Supreme 10 kW</option>
                      <option value="midea_split_12">Midea Split 12 kW</option>
                      <option value="midea_arctic_10">Midea Arctic R290 Monoblok 10 kW</option>
                      <option value="midea_arctic_12">Midea Arctic R290 Monoblok 12 kW</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label class="block text-[10px] text-slate-400 mb-1 uppercase">√ödaje o z√°kazn√≠kovi</label>
                  <textarea id="customerInput" rows="3" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none resize-none">V√°≈æen√Ω z√°kazn√≠k
Ulica 123
000 00 Mesto</textarea>
                </div>

                <button type="button" onclick="downloadPDF()" class="w-full mt-1 flex justify-center items-center gap-2 rounded bg-red-600 hover:bg-red-700 px-4 py-2 text-sm font-bold text-white shadow transition-all active:scale-[0.98]">
                  Stiahnu≈• PDF
                </button>

                <p class="text-[10px] text-slate-300 leading-snug">
                  Pozn.: URL (Netlify/Vercel) v rohu PDF je <b>hlaviƒçka/p√§ta prehliadaƒça</b>.
                  V dial√≥gu tlaƒçe vypni <b>Hlaviƒçky a p√§ty</b>. (K√≥d to nevie spoƒæahlivo skry≈•.)
                </p>

                <!-- ================== PRODUKTOV√Å DATAB√ÅZA (lok√°lne) ================== -->
                <div class="mt-4 pt-4 border-t border-slate-700">
                  <div class="flex items-center justify-between">
                    <h4 class="text-[10px] uppercase tracking-widest text-slate-200 font-bold">Produktov√° datab√°za</h4>
                    <span class="text-[10px] text-slate-400">(uklad√° sa do prehliadaƒça)</span>
                  </div>

                  <div class="mt-3 grid grid-cols-2 gap-2">
                    <div class="col-span-2">
                      <label class="block text-[10px] text-slate-400 mb-1 uppercase">Vyhƒæada≈• produkt</label>
                      <input id="productSearch" type="text" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="napr. Midea Arctic R290, Dra≈æice OKC...">
                      <div id="productSearchResults" class="mt-2 max-h-32 overflow-auto rounded border border-slate-700 bg-slate-800/60"></div>
                    </div>

                    <div>
                      <label class="block text-[10px] text-slate-400 mb-1 uppercase">N√°zov</label>
                      <input id="pName" type="text" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="Midea Arctic R290 10 kW">
                    </div>
                    <div>
                      <label class="block text-[10px] text-slate-400 mb-1 uppercase">Model</label>
                      <input id="pModel" type="text" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="Arctic 10 kW">
                    </div>
                    <div>
                      <label class="block text-[10px] text-slate-400 mb-1 uppercase">Cenn√≠kov√°</label>
                      <input id="pList" type="number" step="0.01" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="6500">
                    </div>
                    <div>
                      <label class="block text-[10px] text-slate-400 mb-1 uppercase">Va≈°a cena</label>
                      <input id="pYour" type="number" step="0.01" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="4600">
                    </div>
                    <div class="col-span-2">
                      <label class="block text-[10px] text-slate-400 mb-1 uppercase">Popis (voliteƒæn√©)</label>
                      <input id="pDesc" type="text" class="w-full rounded bg-slate-800 border border-slate-600 text-white px-2 py-1 text-sm focus:border-red-400 outline-none" placeholder="Invertor, R290, WiFi...">
                    </div>

                    <button type="button" onclick="addProductToDB()" class="col-span-2 rounded bg-slate-200/10 hover:bg-slate-200/20 border border-slate-700 px-3 py-2 text-xs font-bold text-white">
                      + Ulo≈æi≈• produkt do datab√°zy
                    </button>

                    <button type="button" onclick="addSelectedProductToOffer()" class="col-span-2 rounded bg-emerald-600 hover:bg-emerald-700 px-3 py-2 text-xs font-bold text-white">
                      + Prida≈• vybran√Ω produkt do ponuky (Technol√≥gia)
                    </button>

                    <div class="col-span-2 grid grid-cols-2 gap-2">
                      <button type="button" onclick="exportProductsJSON()" class="rounded bg-slate-200/10 hover:bg-slate-200/20 border border-slate-700 px-3 py-2 text-xs font-bold text-white">
                        Export JSON
                      </button>
                      <label class="rounded bg-slate-200/10 hover:bg-slate-200/20 border border-slate-700 px-3 py-2 text-xs font-bold text-white text-center cursor-pointer">
                        Import JSON
                        <input id="importProductsFile" type="file" accept="application/json" class="hidden" />
                      </label>
                    </div>

                    <p class="col-span-2 text-[10px] text-slate-400 leading-snug">
                      Toto je lok√°lna datab√°za (localStorage). Keƒè bude≈° chcie≈• ozajstn√∫ DB na Verceli, napoj√≠me to na Vercel Postgres / Supabase.
                    </p>
                  </div>
                </div>
                <!-- =============================================================== -->
              </div>
            </div>
          </div>

          <div class="header-right">
            <div class="text-slate-300 tracking-[0.4em] text-3xl font-light">PONUKA</div>
            <div class="mt-1 text-lg font-bold text-slate-900"># <span class="text-red-600" id="offerNumberDisplay">2026/001</span></div>
            <div class="mt-2 text-xs text-slate-500">D√°tum vystavenia: <span id="date"></span></div>
            <div class="mt-6 text-right">
              <div class="text-sm text-slate-600">Spektra install s.r.o.</div>
              <div class="text-sm text-slate-600">Holl√©ho 210, 015 01 Rajec</div>
            </div>
            <div class="mt-4 flex justify-end">
              <img src="ONE1.webp" alt="Spektra Install logo" class="h-16 w-auto" onerror="this.style.display='none'" />
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- INFORM√ÅCIE O PROJEKTE -->
    <section class="relative p-8 border-b border-gray-200 avoid-break-inside">
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>
      <h2 class="text-lg font-semibold text-slate-700 mb-4 border-l-4 border-red-600 pl-3">Inform√°cie o projekte</h2>
      <div class="grid grid-cols-2 gap-8 text-sm">
        <div>
          <p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider mb-1">Objekt</p>
          <p class="font-semibold text-slate-800 text-base">Rodinn√Ω dom</p>
          <div class="mt-3">
            <p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider mb-1">Syst√©m</p>
            <p class="font-semibold text-slate-800 text-base">Vzduch / Voda</p>
          </div>
        </div>
        <div>
          <p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider mb-1">Zvolen√° technol√≥gia</p>
          <p class="font-semibold text-slate-800 text-base"><span id="brandText">‚Äî</span></p>
          <div class="mt-3">
            <p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider mb-1">V√Ωkon</p>
            <p class="font-semibold text-slate-800 text-base"><span id="powerText">‚Äî</span></p>
          </div>
        </div>
      </div>
    </section>

    <!-- 1: TECHNOL√ìGIA -->
    <section class="relative p-8">
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>
      <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
        <span class="bg-slate-100 text-slate-600 rounded-full h-8 w-8 flex items-center justify-center mr-2 text-sm font-bold border border-slate-200">1</span>
        Technol√≥gia
      </h3>

      <div class="overflow-hidden rounded-lg border border-gray-200">
        <table class="w-full text-sm text-left text-gray-600">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
            <tr>
              <th class="py-3 px-4 w-5/12">Polo≈æka</th>
              <th class="py-3 px-4 w-3/12">Typ / Model</th>
              <th class="py-3 px-4 text-right text-gray-400 font-normal" id="listPriceHeader">Cenn√≠kov√° cena</th>
              <th class="py-3 px-4 text-right font-bold text-slate-800">Va≈°a cena</th>
            </tr>
          </thead>
          <tbody id="techBody" class="divide-y divide-gray-100"></tbody>
          <tfoot class="bg-slate-50 border-t border-gray-200">
            <tr>
              <td colspan="3" class="py-3 px-4 text-right text-slate-600 font-medium">Spolu za technol√≥giu:</td>
              <td class="py-3 px-4 text-right text-lg font-bold text-slate-900" id="techTotal">0,00 ‚Ç¨</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="mt-2 text-right text-xs text-red-600 font-semibold italic" id="discountNote"></div>
    </section>

    <!-- 2: MONT√Å≈Ω -->
    <section class="relative px-8 pb-4">
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>
      <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
        <span class="bg-slate-100 text-slate-600 rounded-full h-8 w-8 flex items-center justify-center mr-2 text-sm font-bold border border-slate-200">2</span>
        Mont√°≈æ a in≈°tal√°cia
      </h3>

      <div class="overflow-hidden rounded-lg border border-gray-200">
        <table class="w-full text-sm text-left text-gray-600">
          <tbody class="divide-y divide-gray-100" id="installBody"></tbody>
          <tfoot class="bg-slate-50 border-t border-gray-200">
            <tr>
              <td class="py-2 px-4 text-right font-medium">Spolu za mont√°≈æ:</td>
              <td class="py-2 px-4 text-right font-bold text-slate-900" id="installTotal">0,00 ‚Ç¨</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- 3: SLU≈ΩBY -->
    <section class="relative px-8 pb-8">
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>
      <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center">
        <span class="bg-slate-100 text-slate-600 rounded-full h-8 w-8 flex items-center justify-center mr-2 text-sm font-bold border border-slate-200">3</span>
        Ostatn√© slu≈æby
      </h3>

      <div class="overflow-hidden rounded-lg border border-gray-200 avoid-break-inside">
        <table class="w-full text-sm text-left text-gray-600">
          <tbody class="divide-y divide-gray-100" id="servicesBody"></tbody>
          <tfoot class="bg-slate-50 border-t border-gray-200">
            <tr>
              <td class="py-2 px-4 text-right font-medium">Spolu za slu≈æby:</td>
              <td class="py-2 px-4 text-right font-bold text-slate-900" id="servicesTotal">0,00 ‚Ç¨</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- SUM√ÅR -->
    <section class="relative bg-slate-50 p-8 border-t border-gray-200">
      <div class="absolute left-0 top-0 bottom-0 w-1 bg-red-600"></div>

      <div class="flex flex-col md:flex-row justify-between items-start gap-8 avoid-break-inside">
        <div class="w-full md:w-1/2">
          <h4 class="font-bold text-slate-800 mb-3 text-sm uppercase tracking-wide">Kƒæ√∫ƒçov√© v√Ωhody</h4>
          <ul class="text-sm text-slate-600 list-disc list-inside space-y-2 marker:text-red-600" id="notesList"></ul>

          <div class="mt-6 p-3 bg-blue-50/50 rounded border border-blue-100 text-xs text-slate-600 leading-relaxed">
            <p class="font-bold text-blue-800 mb-1">Pozn√°mka k chladiv√°m:</p>
            <p>
              Prebieha postupn√© obmedzovanie chladiva <b>R32</b>. Trend smeruje k ekologick√Ωm chladiv√°m <b>R290 (prop√°n)</b>.
              (Upresni mi pros√≠m: chce≈° do textu uvies≈• konkr√©tny rok ‚Äûod roku X u≈æ len R290‚Äú, alebo to nech√°me v≈°eobecne?)
            </p>
          </div>
        </div>

        <div class="w-full md:w-1/2">
          <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
            <div class="flex justify-between py-1 text-slate-600 text-sm">
              <span>Cena bez DPH:</span>
              <span class="font-medium" id="sumNoVat">0,00 ‚Ç¨</span>
            </div>
            <div class="flex justify-between py-1 text-slate-600 text-sm border-b border-gray-100 mb-2 pb-2">
              <span>DPH (20%):</span>
              <span class="font-medium" id="sumVat">0,00 ‚Ç¨</span>
            </div>
            <div class="flex justify-between items-end py-2">
              <span class="text-slate-800 font-bold text-lg">SPOLU s DPH:</span>
              <span class="text-2xl font-black text-slate-900 tracking-tight" id="sumWithVat">0,00 ‚Ç¨</span>
            </div>

            <div class="mt-4 bg-green-50 p-3 rounded border border-green-200">
              <div class="flex justify-between text-green-700 text-sm mb-1">
                <span>Mo≈æn√° dot√°cia:</span>
                <span class="font-bold" id="subsidyText">- 3 400,00 ‚Ç¨</span>
              </div>
              <div class="flex justify-between text-green-800 font-bold border-t border-green-200 pt-2 mt-1">
                <span>Po odr√°tan√≠ dot√°cie:</span>
                <span id="afterSubsidy">~ 0,00 ‚Ç¨</span>
              </div>
              <p class="text-[10px] text-green-600 mt-1 italic">* Dot√°cia ‚ÄûZelen√° dom√°cnostiam‚Äú podlieha schv√°leniu SIEA.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="bg-slate-800 text-slate-300 p-4 text-center text-xs">
      <p>T√°to cenov√° ponuka je nez√°v√§zn√°. Ceny s√∫ uveden√© vr√°tane recyklaƒçn√Ωch poplatkov.</p>
      <p class="mt-1">¬© 2026 Spektra install s.r.o.</p>
    </footer>

  </div>

<script>
  "use strict";

  function downloadPDF() { window.print(); }

  // ---------- Helpers ----------
  const fmt = (n) => {
    const num = Number(n || 0);
    return num.toLocaleString("sk-SK", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ‚Ç¨";
  };
  const sum = (arr) => arr.reduce((acc, x) => acc + (Number(x.price) || 0), 0);
  const techSum = (rows) => rows.reduce((acc, r) => acc + (Number(r.yourPrice) || 0), 0);

  // ---------- Mont√°≈æ / slu≈æby ----------
  const COMMON_INSTALL_BASE = [
    { label: "Odborn√° mont√°≈æ certifikovan√Ωm technikom (z√°ruka kvality)", price: 950 },
    { label: "Chladiarensk√© prepojenie (v√°kuovanie, sk√∫≈°ka tesnosti)", price: 380 },
    { label: "Profesion√°lne napojenie na vykurovac√≠ syst√©m domu", price: 320 },
    { label: "Mont√°≈æny materi√°l (Cu potrubie, kauƒçukov√° izol√°cia, fitingy, kotvenie)", price: 650 },
    { label: "Elektroin≈°tal√°cia, istenie a komunikaƒçn√© prepojenie", price: 250 },
    { label: "Prestup stenou jadrov√Ωm v≈ïtan√≠m (ƒçist√Ω rez)", price: 65 },
    { label: "Spustenie, hydraulick√© vyv√°≈æenie a za≈°kolenie obsluhy", price: 180 }
  ];

  const SERVICE_PROTOCOL = { label: "Protokol o uveden√≠ do prev√°dzky (kontrola + spustenie)", price: 120 };

  // ---------- Produktov√° DB (localStorage) ----------
  const PRODUCTS_STORAGE_KEY = "spektra_products_v1";
  const OFFER_ADDONS_STORAGE_KEY = "spektra_offer_addons_v1";

  const DEFAULT_PRODUCTS = [
    { id: "p_midea_arctic_10", name: "Tepeln√© ƒçerpadlo Midea Arctic R290 10 kW", model: "Arctic 10 kW", listPrice: 6500, yourPrice: 4600, desc: "Invertor, R290, WiFi" },
    { id: "p_midea_arctic_12", name: "Tepeln√© ƒçerpadlo Midea Arctic R290 12 kW", model: "Arctic 12 kW", listPrice: 7500, yourPrice: 5100, desc: "Invertor, R290, WiFi" },
    { id: "p_drazice_okc200_hp", name: "Z√°sobn√≠k T√öV Dra≈æice OKC 200 NTR/HP", model: "OKC 200", listPrice: 1150, yourPrice: 938.21, desc: "Zv√§ƒç≈°en√Ω v√Ωmenn√≠k pre Tƒå" },
    { id: "p_buffer_100", name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", model: "V 100 l", listPrice: 550, yourPrice: 420, desc: "Hydraulick√° stabilita syst√©mu" }
  ];

  function loadProducts() {
    try {
      const raw = localStorage.getItem(PRODUCTS_STORAGE_KEY);
      if (!raw) return [...DEFAULT_PRODUCTS];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) && parsed.length ? parsed : [...DEFAULT_PRODUCTS];
    } catch {
      return [...DEFAULT_PRODUCTS];
    }
  }
  function saveProducts(products) {
    localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(products));
  }
  function loadOfferAddons() {
    try {
      const raw = localStorage.getItem(OFFER_ADDONS_STORAGE_KEY);
      if (!raw) return {};
      const parsed = JSON.parse(raw);
      return parsed && typeof parsed === "object" ? parsed : {};
    } catch {
      return {};
    }
  }
  function saveOfferAddons(map) {
    localStorage.setItem(OFFER_ADDONS_STORAGE_KEY, JSON.stringify(map));
  }

  let PRODUCTS_DB = [];
  let OFFER_ADDONS = {};
  let selectedProductId = null;

  function normalize(s) { return String(s || "").toLowerCase().trim(); }

  function renderProductSearchResults(q) {
    const box = document.getElementById("productSearchResults");
    if (!box) return;

    const query = normalize(q);
    const results = query
      ? PRODUCTS_DB.filter(p => normalize(p.name).includes(query) || normalize(p.model).includes(query))
      : PRODUCTS_DB.slice(0, 10);

    box.innerHTML = "";
    if (!results.length) {
      box.innerHTML = `<div class="px-2 py-2 text-xs text-slate-400">Niƒç sa nena≈°lo.</div>`;
      return;
    }

    results.forEach(p => {
      const row = document.createElement("button");
      row.type = "button";
      row.className = "w-full text-left px-2 py-2 text-xs hover:bg-slate-700/60 border-b border-slate-700 last:border-b-0";
      row.innerHTML = `
        <div class="flex justify-between gap-2">
          <div>
            <div class="text-white font-semibold">${p.name}</div>
            <div class="text-slate-400">${p.model || "-"}${p.desc ? " ‚Ä¢ " + p.desc : ""}</div>
          </div>
          <div class="text-right">
            <div class="text-emerald-300 font-bold">${fmt(p.yourPrice)}</div>
            <div class="text-slate-500 line-through">${p.listPrice ? fmt(p.listPrice) : ""}</div>
          </div>
        </div>
      `;
      row.addEventListener("click", () => {
        selectedProductId = p.id;
        document.getElementById("pName").value = p.name || "";
        document.getElementById("pModel").value = p.model || "";
        document.getElementById("pList").value = p.listPrice ?? "";
        document.getElementById("pYour").value = p.yourPrice ?? "";
        document.getElementById("pDesc").value = p.desc || "";
      });
      box.appendChild(row);
    });
  }

  function addProductToDB() {
    const nameEl = document.getElementById("pName");
    if (!nameEl) return;

    const name = nameEl.value.trim();
    if (!name) return alert("Zadaj n√°zov produktu.");

    const model = (document.getElementById("pModel").value || "").trim();
    const listPrice = Number(document.getElementById("pList").value || 0) || 0;
    const yourPrice = Number(document.getElementById("pYour").value || 0) || 0;
    const desc = (document.getElementById("pDesc").value || "").trim();

    const id = "p_" + Math.random().toString(36).slice(2, 10);
    const p = { id, name, model, listPrice, yourPrice, desc };

    PRODUCTS_DB = [p, ...PRODUCTS_DB];
    saveProducts(PRODUCTS_DB);

    document.getElementById("productSearch").value = "";
    renderProductSearchResults("");

    selectedProductId = id;
    alert("Produkt ulo≈æen√Ω.");
  }

  function addSelectedProductToOffer() {
    if (!selectedProductId) return alert("Najprv vyber produkt zo zoznamu alebo ho ulo≈æ.");
    const offerKey = document.getElementById("offerSelect").value;
    const p = PRODUCTS_DB.find(x => x.id === selectedProductId);
    if (!p) return alert("Produkt sa nena≈°iel.");

    const row = {
      name: p.name,
      desc: p.desc,
      model: p.model,
      listPrice: p.listPrice,
      yourPrice: p.yourPrice
    };

    const current = Array.isArray(OFFER_ADDONS[offerKey]) ? OFFER_ADDONS[offerKey] : [];
    OFFER_ADDONS[offerKey] = [...current, row];
    saveOfferAddons(OFFER_ADDONS);

    renderOffer(offerKey);
    alert("Produkt pridan√Ω do ponuky (Technol√≥gia).");
  }

  function exportProductsJSON() {
    const blob = new Blob([JSON.stringify(PRODUCTS_DB, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "spektra-produkty.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ---------- Ponuky ----------
  const VAT_RATE = 0.20;
  const DEFAULT_SUBSIDY_EUR = 3400;

  const OFFERS = {
    mitsubishi: {
      brand: "Mitsubishi Electric ‚Äì Zubadan",
      power: "10 ‚Äì 12 kW (ZUBADAN)",
      discountNote: "* Uplatnen√° mimoriadna zƒæava na technol√≥giu.",
      subsidy: 3400,
      notes: [
        "Technol√≥gia Flash Injection ‚Äì pln√Ω vykurovac√≠ v√Ωkon aj pri -15 ¬∞C.",
        "Japonsk√° spoƒæahlivos≈• s garanciou prev√°dzky a≈æ do -28 ¬∞C.",
        "Kompaktn√° vn√∫torn√° jednotka s nerezov√Ωm 200 l z√°sobn√≠kom.",
        "Ide√°lne pre radi√°tory aj podlahov√© vykurovanie."
      ],
      tech: [
        { name: "Vonkaj≈°ia jednotka ZUBADAN 12 kW", desc: "400 V, technol√≥gia vstrekovania", model: "PUD-SHWM120YAA", listPrice: 6535, yourPrice: 5100 },
        { name: "Hydrobox - Vn√∫torn√° jednotka All-in-One", desc: "Z√°sobn√≠k T√öV 200 l + z√°lo≈æn√Ω ohrev", model: "ERST20D-YM9D", listPrice: 6841, yourPrice: 5400 },
        { name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", desc: "Hydraulick√° stabilita syst√©mu", model: "V 100 l", listPrice: 550, yourPrice: 420 },
        { name: "Inteligentn√° regul√°cia Mitsubishi (FTC)", desc: "Intuit√≠vne ovl√°danie", model: "V CENE", listPrice: null, yourPrice: 0 }
      ],
      installBase: COMMON_INSTALL_BASE,
      services: [
        SERVICE_PROTOCOL,
        { label: "Odvoz odpadu vzniknut√©ho pri in≈°tal√°cii", price: 60 }
      ]
    },

    panasonic_split: {
      brand: "Panasonic ‚Äì Aquarea K Series",
      power: "9 kW",
      discountNote: "",
      subsidy: 3400,
      notes: [
        "Najnov≈°ia gener√°cia K Series ‚Äì modern√Ω dizajn.",
        "Veƒæmi tich√° prev√°dzka ‚Äì vhodn√© do hustej z√°stavby.",
        "All-in-One rie≈°enie so 185 l nerezov√Ωm z√°sobn√≠kom.",
        "Smart Cloud: Ovl√°danie cez mobiln√∫ aplik√°ciu."
      ],
      tech: [
        { name: "Vonkaj≈°ia jednotka Panasonic Aquarea", desc: "9 kW, 1-f√°za, R32", model: "WH-UDZ09KE5", listPrice: 4100, yourPrice: 3100 },
        { name: "Vn√∫torn√° jednotka All-in-One (s T√öV)", desc: "Z√°sobn√≠k 185 l, Smart Cloud", model: "WH-ADC0309K3E5", listPrice: 6500, yourPrice: 4900 },
        { name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", desc: "Hydraulick√° stabilita syst√©mu", model: "V 100 l", listPrice: 550, yourPrice: 420 }
      ],
      installBase: COMMON_INSTALL_BASE,
      services: [
        SERVICE_PROTOCOL,
        { label: "Odvoz odpadu vzniknut√©ho pri in≈°tal√°cii", price: 60 }
      ]
    },

    hyundai_supreme_10: {
      brand: "Hyundai ‚Äì Supreme (Split)",
      power: "10 kW (230 V)",
      discountNote: "",
      subsidy: 3400,
      notes: [
        "Pr√©miov√Ω ƒçierny dizajn vonkaj≈°ej jednotky.",
        "Vn√∫torn√° jednotka All-in-One so 190 l z√°sobn√≠kom.",
        "Integrovan√° el. ≈°pir√°la 3 kW a WiFi ovl√°danie.",
        "V√Ωborn√Ω pomer cena / v√Ωkon."
      ],
      tech: [
        { name: "Vonkaj≈°ia jednotka Hyundai Supreme 10 kW", desc: "1-f√°za, R32", model: "HPSO 10kW", listPrice: 4200, yourPrice: 3100 },
        { name: "Vn√∫torn√° jednotka All-in-One", desc: "Z√°sobn√≠k 190 l", model: "HPSA 190L", listPrice: 4800, yourPrice: 3400 },
        { name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", desc: "Hydraulick√° stabilita syst√©mu", model: "V 100 l", listPrice: 550, yourPrice: 420 }
      ],
      installBase: COMMON_INSTALL_BASE,
      services: [
        SERVICE_PROTOCOL,
        { label: "Odvoz odpadu vzniknut√©ho pri in≈°tal√°cii", price: 60 }
      ]
    },

    midea_split_12: {
      brand: "Midea ‚Äì M-Thermal Arctic (Split)",
      power: "12 kW",
      discountNote: "",
      subsidy: 3400,
      notes: [
        "Osvedƒçen√° split kon≈°trukcia (oddelen√© okruhy).",
        "Vn√∫torn√° jednotka 've≈æa' s integrovan√Ωm z√°sobn√≠kom T√öV.",
        "Vysok√° √∫ƒçinnos≈• vykurovania aj chladenia.",
        "Stabiln√Ω v√Ωkon a tich√° prev√°dzka."
      ],
      tech: [
        { name: "Vonkaj≈°ia jednotka Midea 12 kW", desc: "Split syst√©m, R32", model: "MHA-V12W", listPrice: 3900, yourPrice: 2900 },
        { name: "Vn√∫torn√° jednotka All-in-One", desc: "Integrovan√Ω z√°sobn√≠k T√öV", model: "HBT-A160", listPrice: 5600, yourPrice: 3600 },
        { name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", desc: "Hydraulick√° stabilita syst√©mu", model: "V 100 l", listPrice: 550, yourPrice: 420 }
      ],
      installBase: COMMON_INSTALL_BASE,
      services: [
        SERVICE_PROTOCOL,
        { label: "Odvoz odpadu vzniknut√©ho pri in≈°tal√°cii", price: 60 }
      ]
    },

    midea_arctic_10: {
      brand: "Midea ‚Äì Arctic R290 (monoblok)",
      power: "cca 10 kW",
      discountNote: "",
      subsidy: 3400,
      notes: [
        "Ekologick√© chladivo R290 (Prop√°n) ‚Äì bud√∫cnos≈• bez obmedzen√≠.",
        "Monoblok syst√©m ‚Äì voda v exteri√©ri.",
        "Vhodn√© pre rekon≈°trukcie (vy≈°≈°ia teplota vody).",
        "Osvedƒçen√Ω z√°sobn√≠k Dra≈æice."
      ],
      tech: [
        { name: "Tepeln√© ƒçerpadlo Midea Arctic R290 10 kW", desc: "Invertor, WiFi", model: "Arctic 10 kW", listPrice: 6500, yourPrice: 4600 },
        { name: "Z√°sobn√≠k T√öV Dra≈æice OKC 200 NTR/HP", desc: "Zv√§ƒç≈°en√° v√Ωhrevn√° plocha", model: "OKC 200", listPrice: 1150, yourPrice: 938.21 },
        { name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", desc: "Hydraulick√° stabilita syst√©mu", model: "V 100 l", listPrice: 550, yourPrice: 420 }
      ],
      installBase: COMMON_INSTALL_BASE,
      services: [
        SERVICE_PROTOCOL,
        { label: "Odvoz odpadu vzniknut√©ho pri in≈°tal√°cii", price: 60 }
      ]
    },

    midea_arctic_12: {
      brand: "Midea ‚Äì Arctic R290 (monoblok)",
      power: "cca 12 kW",
      discountNote: "",
      subsidy: 3400,
      notes: [
        "Zv√Ω≈°en√Ω v√Ωkon 12 kW ‚Äì rezerva pre chladnej≈°ie dni.",
        "Ekologick√© a bezpeƒçn√© chladivo R290.",
        "Tich√° prev√°dzka vonkaj≈°ej jednotky.",
        "Kompletn√© rie≈°enie so z√°sobn√≠kom Dra≈æice."
      ],
      tech: [
        { name: "Tepeln√© ƒçerpadlo Midea Arctic R290 12 kW", desc: "Vysok√Ω v√Ωkon, WiFi", model: "Arctic 12 kW", listPrice: 7500, yourPrice: 5100 },
        { name: "Z√°sobn√≠k T√öV Dra≈æice OKC 200 NTR/HP", desc: "Zv√§ƒç≈°en√Ω v√Ωmenn√≠k", model: "OKC 200", listPrice: 1150, yourPrice: 938.21 },
        { name: "Akumulaƒçn√° n√°doba 100 l (Buffer)", desc: "Hydraulick√° stabilita syst√©mu", model: "V 100 l", listPrice: 550, yourPrice: 420 }
      ],
      installBase: COMMON_INSTALL_BASE,
      services: [
        SERVICE_PROTOCOL,
        { label: "Odvoz odpadu vzniknut√©ho pri in≈°tal√°cii", price: 60 }
      ]
    }
  };

  function renderOffer(key) {
    const offer = OFFERS[key];
    if (!offer) return;

    const addons = Array.isArray(OFFER_ADDONS[key]) ? OFFER_ADDONS[key] : [];
    const techRows = [...offer.tech, ...addons];

    // Texty v hlaviƒçke
    const brandEl = document.getElementById("brandText");
    const powerEl = document.getElementById("powerText");
    const discountEl = document.getElementById("discountNote");
    if (brandEl) brandEl.textContent = offer.brand;
    if (powerEl) powerEl.textContent = offer.power;
    if (discountEl) discountEl.textContent = offer.discountNote || "";

    // Technol√≥gia
    const techBody = document.getElementById("techBody");
    if (!techBody) return;
    techBody.innerHTML = "";

    const showListPrice = techRows.some(r => typeof r.listPrice === "number");
    const listHeader = document.getElementById("listPriceHeader");
    if (listHeader) listHeader.textContent = showListPrice ? "Cenn√≠kov√° cena" : "Pozn√°mka";

    techRows.forEach(r => {
      const tr = document.createElement("tr");

      const listCell = showListPrice
        ? (typeof r.listPrice === "number"
            ? `<td class="py-3 px-4 text-right text-slate-400 line-through decoration-red-300 text-xs">${fmt(r.listPrice)}</td>`
            : `<td class="py-3 px-4 text-right text-slate-400 text-xs">-</td>`
          )
        : `<td class="py-3 px-4 text-right text-slate-400 text-xs">${r.desc ? " " : "-"}</td>`;

      tr.innerHTML = `
        <td class="py-3 px-4 font-medium text-slate-900">
          ${r.name}
          ${r.desc ? `<div class="text-xs text-slate-500 font-normal mt-0.5">${r.desc}</div>` : ``}
        </td>
        <td class="py-3 px-4 text-slate-600">${r.model || "-"}</td>
        ${listCell}
        <td class="py-3 px-4 text-right font-bold text-slate-900">${fmt(r.yourPrice)}</td>
      `;
      techBody.appendChild(tr);
    });

    const techTotal = techSum(techRows);
    const techTotalEl = document.getElementById("techTotal");
    if (techTotalEl) techTotalEl.textContent = fmt(techTotal);

    // Mont√°≈æ
    const installBody = document.getElementById("installBody");
    if (installBody) {
      installBody.innerHTML = "";
      offer.installBase.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 px-4 w-3/4 text-slate-700">${r.label}</td>
          <td class="py-2 px-4 text-right text-slate-900 font-medium">${fmt(r.price)}</td>
        `;
        installBody.appendChild(tr);
      });
    }

    const installTotal = sum(offer.installBase);
    const installTotalEl = document.getElementById("installTotal");
    if (installTotalEl) installTotalEl.textContent = fmt(installTotal);

    // Slu≈æby
    const servicesBody = document.getElementById("servicesBody");
    if (servicesBody) {
      servicesBody.innerHTML = "";
      offer.services.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 px-4 w-3/4 text-slate-700">${r.label}</td>
          <td class="py-2 px-4 text-right text-slate-900 font-medium">${fmt(r.price)}</td>
        `;
        servicesBody.appendChild(tr);
      });
    }

    const servicesTotal = sum(offer.services);
    const servicesTotalEl = document.getElementById("servicesTotal");
    if (servicesTotalEl) servicesTotalEl.textContent = fmt(servicesTotal);

    // Pozn√°mky
    const notesList = document.getElementById("notesList");
    if (notesList) {
      notesList.innerHTML = "";
      offer.notes.forEach(n => {
        const li = document.createElement("li");
        li.textContent = n;
        notesList.appendChild(li);
      });
    }

    // S√∫hrn
    const totalNoVat = techTotal + installTotal + servicesTotal;
    const vat = totalNoVat * VAT_RATE;
    const totalWithVat = totalNoVat + vat;

    const sumNoVatEl = document.getElementById("sumNoVat");
    const sumVatEl = document.getElementById("sumVat");
    const sumWithVatEl = document.getElementById("sumWithVat");
    if (sumNoVatEl) sumNoVatEl.textContent = fmt(totalNoVat);
    if (sumVatEl) sumVatEl.textContent = fmt(vat);
    if (sumWithVatEl) sumWithVatEl.textContent = fmt(totalWithVat);

    const subsidy = Number(offer.subsidy ?? DEFAULT_SUBSIDY_EUR);
    const subsidyTextEl = document.getElementById("subsidyText");
    if (subsidyTextEl) subsidyTextEl.textContent = "- " + fmt(subsidy);

    const after = Math.max(0, totalWithVat - subsidy);
    const afterEl = document.getElementById("afterSubsidy");
    if (afterEl) afterEl.textContent = "~ " + fmt(after);
  }

  // ---------- Boot (DOM ready) ----------
  document.addEventListener("DOMContentLoaded", () => {
    // Mini "tests" (pom√¥≈æe odhali≈• zl√© ID hneƒè v konzole)
    const must = [
      "offerSelect", "offerNumberDisplay", "offerNumberInput",
      "customerInput", "customerDisplay", "date",
      "techBody", "installBody", "servicesBody",
      "sumNoVat", "sumVat", "sumWithVat"
    ];
    must.forEach(id => console.assert(document.getElementById(id), `Missing element #${id}`));

    PRODUCTS_DB = loadProducts();
    OFFER_ADDONS = loadOfferAddons();

    // D√°tum
    const dateEl = document.getElementById("date");
    if (dateEl) {
      const today = new Date();
      dateEl.textContent = today.toLocaleDateString('sk-SK', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Prepojenie editor -> v√Ωstup
    const offerNumberInput = document.getElementById("offerNumberInput");
    const offerNumberDisplay = document.getElementById("offerNumberDisplay");
    if (offerNumberInput && offerNumberDisplay) {
      offerNumberDisplay.textContent = offerNumberInput.value || "2026/001";
      offerNumberInput.addEventListener("input", () => {
        offerNumberDisplay.textContent = offerNumberInput.value || "2026/001";
      });
    }

    const customerInput = document.getElementById("customerInput");
    const customerDisplay = document.getElementById("customerDisplay");
    if (customerInput && customerDisplay) {
      customerDisplay.textContent = customerInput.value;
      customerInput.addEventListener("input", () => {
        customerDisplay.textContent = customerInput.value;
      });
    }

    const sel = document.getElementById("offerSelect");
    if (sel) {
      sel.addEventListener("change", () => renderOffer(sel.value));
    }

    // Product search
    const ps = document.getElementById("productSearch");
    if (ps) {
      ps.addEventListener("input", () => renderProductSearchResults(ps.value));
      renderProductSearchResults("");
    }

    // Import JSON
    const importFile = document.getElementById("importProductsFile");
    if (importFile) {
      importFile.addEventListener("change", async (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const parsed = JSON.parse(text);
          if (!Array.isArray(parsed)) throw new Error("JSON mus√≠ by≈• pole produktov");
          // Basic validation
          const cleaned = parsed
            .filter(x => x && typeof x === "object" && x.name)
            .map(x => ({
              id: x.id || ("p_" + Math.random().toString(36).slice(2, 10)),
              name: String(x.name),
              model: x.model ? String(x.model) : "",
              listPrice: Number(x.listPrice || 0) || 0,
              yourPrice: Number(x.yourPrice || 0) || 0,
              desc: x.desc ? String(x.desc) : ""
            }));
          if (!cleaned.length) throw new Error("Nena≈°li sa platn√© produkty");
          PRODUCTS_DB = cleaned;
          saveProducts(PRODUCTS_DB);
          renderProductSearchResults("");
          alert("Import OK.");
        } catch (err) {
          alert("Import zlyhal: " + (err?.message || err));
        } finally {
          e.target.value = "";
        }
      });
    }

    // Initial render
    const initialKey = (sel && sel.value) ? sel.value : "mitsubishi";
    renderOffer(initialKey);
  });
</script>

</body>
</html>
